<!DOCTYPE html>

<head>

</head>

<body>
    <h1>Salesforce OAuth Example</h1>
    <div id="content">
        <a id="loginWithSalesforce" class="button" href="#">
            Log in with Salesforce
        </a>
        <div id="result"></div>
    </div>

    <script>
        const authEndpoint = "https://orgfarm-2b36a5883e-dev-ed.develop.lightning.force.com/services/oauth2/authorize"; // Use "test.salesforce.com" for Sandbox environments
        var clientId = '3MVG97L7PWbPq6Uzh6BOO0UcrtX0dJzfRhowVhD0VkzXxcWZXIoza7o1zCDipqcwAahtOgvDtCTbkc2h6aV0M';
        var redirectUri = 'https://amit-rajput2007.github.io/WebServer';
        var scope = 'web';

        // const generateAuthUrl = () => {
        // const buttonElem = document.querySelector("#loginWithSalesforce");

        //if (buttonElem) {
        //  buttonElem.addEventListener("click", () => {
        //return window.location.href = `${authEndpoint}?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;


        //})
        //}
        //}
        const generateAuthUrl = () => {
            return `${authEndpoint}?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
        };

        document.getElementById("loginWithSalesforce").setAttribute("href", generateAuthUrl());


        const getAuthorizationCode = () => {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('urlParams ', urlParams);
            return urlParams.get("code");
        }

        const contacts = (accessToken) => {
            fetch('https://orgfarm-2b36a5883e-dev-ed.develop.lightning.force.com/services/data/v65.0/sobjects/Contact/003g5000001ISGbAAO', {
                Method: 'GET',
                headers: {
                    'Content-Type': 'Application/JSON',
                    'Authorization': `Bearer ${accessToken}`
                }


            }).then((response) => {
                console.log('response ', response);
                if (!response.ok) {
                    console.log('Error  getting contact data ', response.status);

                }
                return response.json();

            }).then((data) => {

                console.log('contact datat ', data);

            }).catch((error) => {

                console.error('Error fetching protected resource:', error);
            })

        }

        const exchangeToken = async (authorizationCode) => {
            let accessToken = '';
            try {
                const response = await fetch("https://singlepage-fy8q.onrender.com/getAccessToken", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ code: authorizationCode }),
                });
                console.log('response ', response)
                if (!response.ok) {
                    throw new Error("Failed to exchange token");
                }

                const data = await response.json();
                console.log("data:", data);
                console.log("data:", JSON.stringify(data));
                console.log("Access Token:", data.accessToken);
                accessToken = data.accessToken
                document.getElementById("result").innerHTML =
                    "<p style='color: green;'>Access Token: " +
                    data.accessToken +
                    "</p>";
            } catch (error) {
                console.error("Error exchanging token:", error);
                document.getElementById("result").innerHTML =
                    "<p style='color: red;'>Error: " + error.message + "</p>";
            }
            return accessToken;
        };
        const auth_code = getAuthorizationCode();
        console.log('auth_code ', auth_code);
        if (auth_code) {
            const accessToken = exchangeToken(auth_code);
            contacts(accessToken);
        }
        else {
            document.getElementById("loginWithSalesforce").setAttribute("href", generateAuthUrl());
        }
        document.querySelector("#loginWithSalesforce").addEventListener("click", () => {
            console.log('auth_code ', auth_code);
            exchangeToken(auth_code);


        })






    </script>
</body>